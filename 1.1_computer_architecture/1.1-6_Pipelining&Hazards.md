# 1.1-6 Pipelining & Hazards

> Active Recall
> 
> - What is pipelining?
> - What are the three types of hazards in a pipeline?
> - How can each hazard be resolved?
> - What are superscalar and out-of-order execution?

---

## Pipelining

- A technique that divides the instruction execution process into multiple stages so that several instructions can be executed concurrently.
- **Goal**: Increase CPU throughput and improve performance.
- A typical 5-stage pipeline:
    1. IF (Instruction Fetch)
    2. ID (Instruction Decode)
    3. EX (Execute)
    4. MEM (Memory Access)
    5. WB (Write Back)

---

## Hazards

**Hazard**: A situation where the instruction pipeline cannot proceed smoothly and stalls occur.

---

### Data Hazard

Occurs when a subsequent instruction depends on the result of a previous one that has not yet been computed.

- **Solutions**: Forwarding, Stall

**Forwarding**

- Passes the ALU result directly to the next instruction before it is written back to the register.
- Resolves dependencies without stalling.

**Stall**

- The CPU waits for a few cycles until the result is ready.
- Easy to implement but reduces performance.

---

### Control Hazard

Occurs when the outcome of a branch instruction is not yet known, so the next instruction flow is uncertain.

- **Solutions**: Branch Prediction, Delayed Branch

**Branch Prediction**

- Predicts whether a branch will be taken or not.
- Can be **Static** (always taken/not taken) or **Dynamic** (based on execution history).

**Delayed Branch**

- Used in early pipeline CPUs like MIPS.
- The instruction immediately after a branch is always executed, regardless of branch outcome.

---

### Structural Hazard

Occurs when multiple pipeline stages require the same hardware resource at the same time.

- **Solutions**: Resource Duplication, Resource Pipelining

**Resource Duplication**

- Split instruction and data memory (Harvard Architecture), so one stage can access data while another fetches instructions.

**Resource Pipelining**

- Partition the resource into multiple stages to allow concurrent access.

**⇒ Structural hazards are rare in modern CPUs, since resources are typically duplicated or separated.**

---

## Advanced Techniques (Key in Modern CPUs)

1. **Superscalar**
    - Multiple instructions are issued per clock cycle.
    - Achieved by equipping the CPU with multiple ALUs, load/store units, etc.
    - Examples: Most modern x86 and ARM Cortex-A processors.
2. **Out-of-Order Execution (OoO)**
    - Instructions without dependencies can be executed earlier, regardless of program order.
    - Minimizes stalls caused by data hazards.
    - Requires a **Reorder Buffer (ROB)** and **Register Renaming**, the latter also resolving WAR/WAW hazards.
3. **Speculation (Speculative Execution)**
    - Executes instructions based on branch prediction.
    - If prediction is correct → performance boost; if wrong → pipeline flush.
    - Related to modern CPU vulnerabilities like Spectre and Meltdown.
4. **VLIW (Very Long Instruction Word)** – Advanced
    - Bundles multiple operations into a single long instruction for parallel execution.
    - Relies heavily on the compiler.
    - Rare in general-purpose CPUs; more common in DSPs and some GPUs.
